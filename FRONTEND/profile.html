<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artisan Hub | Profile</title>
    <meta name="description" content="Artist profile on Artisan Hub">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .profile-hero {
            position: relative;
            height: 260px;
            border-radius: 0 0 20px 20px;
            overflow: hidden;
        }

        .profile-banner {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-banner-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, var(--bg-primary) 0%, transparent 60%);
        }

        .profile-header {
            position: relative;
            max-width: 900px;
            margin: -60px auto 0;
            padding: 0 24px;
            display: flex;
            align-items: flex-end;
            gap: 24px;
            z-index: 10;
        }

        .profile-main-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--bg-primary);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .profile-info {
            flex: 1;
            padding-bottom: 8px;
        }

        .profile-display-name {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-bio {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 4px;
            max-width: 500px;
        }

        .profile-location {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            padding-bottom: 12px;
        }

        .profile-stats-bar {
            max-width: 900px;
            margin: 20px auto 0;
            padding: 0 24px;
            display: flex;
            gap: 32px;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 16px;
        }

        .profile-stat-item {
            text-align: center;
        }

        .profile-stat-num {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--amber-400);
        }

        .profile-stat-lbl {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-tabs {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .profile-tab {
            padding: 14px 24px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .profile-tab.active {
            color: var(--amber-400);
            border-bottom-color: var(--amber-400);
        }

        .profile-tab:hover {
            color: var(--text-primary);
        }

        .profile-content {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }

        .portfolio-item {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .portfolio-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--border-hover);
        }

        .portfolio-item img,
        .portfolio-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portfolio-item .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: flex-end;
            padding: 16px;
        }

        .portfolio-item:hover .overlay {
            opacity: 1;
        }

        .portfolio-text-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
        }

        .skills-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .about-section {
            max-width: 600px;
        }

        .about-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .about-row i {
            width: 20px;
            color: var(--amber-400);
        }

        .about-row span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 8px;
            color: #9ca3af;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.08);
        }

        .edit-profile-modal {
            display: none;
        }

        .edit-profile-modal.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="feed.html" class="navbar-logo">
            <img src="cropped_circle_image.png" alt="Artisan Hub">
            <span>Artisan Hub</span>
        </a>
        <div class="nav-links">
            <a href="feed.html" class="nav-link"><i class="fas fa-home"></i> Feed</a>
            <a href="explore.html" class="nav-link"><i class="fas fa-compass"></i> Explore</a>
            <a href="chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
        </div>
        <div class="navbar-actions">
            <button class="nav-btn" title="Notifications"><i class="fas fa-bell"></i></button>
            <div class="dropdown">
                <img src="" alt="Profile" class="nav-avatar" id="navAvatar"
                    onclick="document.getElementById('profileDropdown').classList.toggle('active')">
                <div class="dropdown-menu" id="profileDropdown">
                    <button class="dropdown-item" onclick="window.location.href='profile.html'"><i
                            class="fas fa-user"></i> My Profile</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()" style="color:#ef4444;"><i
                            class="fas fa-sign-out-alt"></i> Sign Out</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Hero -->
    <div class="profile-hero" style="margin-top: 64px;">
        <div id="bannerContainer"
            style="width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
        </div>
        <div class="profile-banner-overlay"></div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <img src="" alt="" class="profile-main-avatar" id="profileAvatar">
        <div class="profile-info">
            <h1 class="profile-display-name" id="profileName">Loading...</h1>
            <p class="profile-bio" id="profileBio"></p>
            <p class="profile-location" id="profileLocation"></p>
        </div>
        <div class="profile-actions" id="profileActions"></div>
    </div>

    <!-- Stats -->
    <div class="profile-stats-bar" id="profileStats">
        <div class="profile-stat-item">
            <div class="profile-stat-num" id="postsCount">0</div>
            <div class="profile-stat-lbl">Posts</div>
        </div>
        <div class="profile-stat-item">
            <div class="profile-stat-num" id="followersCount">0</div>
            <div class="profile-stat-lbl">Followers</div>
        </div>
        <div class="profile-stat-item">
            <div class="profile-stat-num" id="followingCount">0</div>
            <div class="profile-stat-lbl">Following</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs">
        <div class="profile-tab active" onclick="switchTab('posts')">Posts</div>
        <div class="profile-tab" onclick="switchTab('about')">About</div>
    </div>

    <!-- Content -->
    <div class="profile-content">
        <div id="tab-posts">
            <div class="portfolio-grid" id="portfolioGrid">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        <div id="tab-about" style="display: none;">
            <div class="about-section glass-card" id="aboutSection" style="margin-top: 16px;"></div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay edit-profile-modal" id="editModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="modal-close" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Name</label>
                    <input class="input-field" id="editName">
                </div>
                <div class="input-group">
                    <label>Bio</label>
                    <textarea class="input-field" id="editBio" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Skills (comma separated)</label>
                    <input class="input-field" id="editSkills">
                </div>
                <div class="input-group">
                    <label>Location</label>
                    <input class="input-field" id="editLocation">
                </div>
                <div class="input-group">
                    <label>Website</label>
                    <input class="input-field" id="editWebsite">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" onclick="saveProfile()">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let profileData = null;
        let isOwnProfile = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('id');
            loadProfile(userId);
        });

        async function loadProfile(userId) {
            try {
                const currentUser = getCurrentUser();
                document.getElementById('navAvatar').src = getAvatar(currentUser?.avatar, currentUser?.name);

                if (!userId || userId === currentUser?._id) {
                    profileData = await api.get('/auth/me');
                    isOwnProfile = true;
                } else {
                    profileData = await api.get(`/users/${userId}`);
                    isOwnProfile = profileData._id === currentUser?._id;
                }

                renderProfile();
                loadUserPosts(profileData._id);
            } catch (error) {
                showToast('Failed to load profile', 'error');
            }
        }

        function renderProfile() {
            const u = profileData;
            document.getElementById('profileAvatar').src = getAvatar(u.avatar, u.name);
            document.getElementById('profileName').innerHTML = `${u.name} ${verifiedBadge(u.isVerified, 'verified-badge-lg')}`;
            document.getElementById('profileBio').textContent = u.bio || 'No bio yet';
            document.getElementById('profileLocation').innerHTML = u.location ? `<i class="fas fa-map-marker-alt"></i> ${u.location}` : '';
            document.getElementById('followersCount').textContent = u.followers?.length || 0;
            document.getElementById('followingCount').textContent = u.following?.length || 0;

            const actions = document.getElementById('profileActions');
            if (isOwnProfile) {
                actions.innerHTML = `<button class="btn btn-outline" onclick="openEditModal()"><i class="fas fa-edit"></i> Edit Profile</button>`;
            } else {
                const currentUser = getCurrentUser();
                const isFollowing = u.followers?.includes(currentUser?._id);
                actions.innerHTML = `
                <button class="btn ${isFollowing ? 'btn-ghost' : 'btn-primary'}" onclick="toggleFollow('${u._id}', this)">
                    ${isFollowing ? 'Following' : 'Follow'}
                </button>
                <button class="btn btn-outline" onclick="startChat('${u._id}')"><i class="fas fa-comment"></i> Message</button>
            `;
            }

            // About tab
            const about = document.getElementById('aboutSection');
            about.innerHTML = `
            ${u.skills?.length ? `
                <h3 style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">Skills & Expertise</h3>
                <div class="skills-section">${u.skills.map(s => `<span class="tag">${s}</span>`).join('')}</div>
            ` : ''}
            <div class="about-row"><i class="fas fa-user-tag"></i><span>${u.role === 'production_company' ? 'ðŸŽ¬ Production Company' : 'ðŸŽ¨ Artist'}</span></div>
            ${u.location ? `<div class="about-row"><i class="fas fa-map-marker-alt"></i><span>${u.location}</span></div>` : ''}
            ${u.website ? `<div class="about-row"><i class="fas fa-globe"></i><span><a href="${u.website}" target="_blank">${u.website}</a></span></div>` : ''}
            ${u.email ? `<div class="about-row"><i class="fas fa-envelope"></i><span>${u.email}</span></div>` : ''}
            <div class="about-row"><i class="fas fa-calendar"></i><span>Joined ${new Date(u.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span></div>
        `;
        }

        async function loadUserPosts(userId) {
            try {
                const posts = await api.get(`/posts/user/${userId}`);
                const grid = document.getElementById('portfolioGrid');
                document.getElementById('postsCount').textContent = posts.length;

                if (posts.length === 0) {
                    grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-palette"></i><h3>No posts yet</h3><p>${isOwnProfile ? 'Start sharing your artwork!' : 'This artist hasn\'t posted yet.'}</p></div>`;
                    return;
                }

                grid.innerHTML = posts.map(post => {
                    if (post.type === 'image' && post.mediaUrl) {
                        return `
                        <div class="portfolio-item">
                            <img src="${post.mediaUrl}" alt="Artwork" loading="lazy">
                            <div class="overlay">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${post.content?.substring(0, 50) || ''}</div>
                                    <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;"><i class="fas fa-heart"></i> ${post.likes?.length || 0} &nbsp; <i class="fas fa-comment"></i> ${post.comments?.length || 0}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    } else if (post.type === 'video' && post.mediaUrl) {
                        return `
                        <div class="portfolio-item">
                            <video src="${post.mediaUrl}"></video>
                            <div class="overlay">
                                <div><i class="fas fa-play" style="font-size: 1.5rem;"></i></div>
                            </div>
                        </div>
                    `;
                    } else {
                        return `
                        <div class="portfolio-text-item">
                            <i class="fas fa-pen-fancy" style="color: var(--amber-400); margin-bottom: 8px;"></i>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">${post.content?.substring(0, 200) || ''}${post.content?.length > 200 ? '...' : ''}</p>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px;"><i class="fas fa-heart"></i> ${post.likes?.length || 0}</div>
                        </div>
                    `;
                    }
                }).join('');
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.profile-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById('tab-posts').style.display = tab === 'posts' ? 'block' : 'none';
            document.getElementById('tab-about').style.display = tab === 'about' ? 'block' : 'none';
        }

        async function toggleFollow(userId, btn) {
            try {
                const data = await api.put(`/users/${userId}/follow`);
                btn.textContent = data.following ? 'Following' : 'Follow';
                btn.className = `btn ${data.following ? 'btn-ghost' : 'btn-primary'}`;
                loadProfile(userId);
            } catch (error) {
                showToast('Failed', 'error');
            }
        }

        function startChat(userId) {
            window.location.href = `chat.html?user=${userId}`;
        }

        function openEditModal() {
            document.getElementById('editName').value = profileData.name || '';
            document.getElementById('editBio').value = profileData.bio || '';
            document.getElementById('editSkills').value = (profileData.skills || []).join(', ');
            document.getElementById('editLocation').value = profileData.location || '';
            document.getElementById('editWebsite').value = profileData.website || '';
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveProfile() {
            try {
                const data = {
                    name: document.getElementById('editName').value.trim(),
                    bio: document.getElementById('editBio').value.trim(),
                    skills: document.getElementById('editSkills').value,
                    location: document.getElementById('editLocation').value.trim(),
                    website: document.getElementById('editWebsite').value.trim()
                };
                await api.put('/users/profile', data);
                showToast('Profile updated!', 'success');
                closeEditModal();
                await refreshUser();
                loadProfile();
            } catch (error) {
                showToast('Failed to update: ' + error.message, 'error');
            }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.getElementById('profileDropdown')?.classList.remove('active');
            }
        });
    </script>
</body>

</html>